# ============================================
# Makefile - GS Produ√ß√µes Intranet
# Comandos simplificados para Docker
# ============================================

.PHONY: help build up down restart logs shell db-shell migrate seed clean

# Vari√°veis
COMPOSE_FILE_PROD = docker/docker-compose.yml
COMPOSE_FILE_DEV = docker/docker-compose.dev.yml
APP_CONTAINER = gsproducoes-app
DB_CONTAINER = gsproducoes-db

# Comando padr√£o
.DEFAULT_GOAL := help

# ==========================================
# Help
# ==========================================
help: ## Mostrar esta mensagem de ajuda
	@echo "üöÄ GS Produ√ß√µes Intranet - Docker Commands"
	@echo ""
	@echo "Comandos dispon√≠veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ==========================================
# Produ√ß√£o
# ==========================================
build: ## Build das imagens de produ√ß√£o
	@echo "üî® Construindo imagens..."
	docker-compose -f $(COMPOSE_FILE_PROD) build

up: ## Iniciar ambiente de produ√ß√£o
	@echo "üöÄ Iniciando ambiente de produ√ß√£o..."
	docker-compose -f $(COMPOSE_FILE_PROD) up -d
	@echo "‚úÖ Ambiente iniciado!"
	@echo "üìç Aplica√ß√£o: http://localhost:3000"
	@echo "üìç Adminer: http://localhost:8080"

down: ## Parar ambiente de produ√ß√£o
	@echo "üõë Parando ambiente..."
	docker-compose -f $(COMPOSE_FILE_PROD) down

restart: ## Reiniciar ambiente de produ√ß√£o
	@echo "üîÑ Reiniciando ambiente..."
	docker-compose -f $(COMPOSE_FILE_PROD) restart

# ==========================================
# Desenvolvimento
# ==========================================
dev-build: ## Build das imagens de desenvolvimento
	@echo "üî® Construindo imagens de desenvolvimento..."
	docker-compose -f $(COMPOSE_FILE_DEV) build

dev-up: ## Iniciar ambiente de desenvolvimento
	@echo "üöÄ Iniciando ambiente de desenvolvimento..."
	docker-compose -f $(COMPOSE_FILE_DEV) up -d
	@echo "‚úÖ Ambiente iniciado!"
	@echo "üìç Aplica√ß√£o: http://localhost:3000"
	@echo "üìç Adminer: http://localhost:8080"

dev-down: ## Parar ambiente de desenvolvimento
	@echo "üõë Parando ambiente de desenvolvimento..."
	docker-compose -f $(COMPOSE_FILE_DEV) down

dev-restart: ## Reiniciar ambiente de desenvolvimento
	@echo "üîÑ Reiniciando ambiente de desenvolvimento..."
	docker-compose -f $(COMPOSE_FILE_DEV) restart

# ==========================================
# Logs
# ==========================================
logs: ## Ver logs de todos os servi√ßos
	docker-compose -f $(COMPOSE_FILE_PROD) logs -f

logs-app: ## Ver logs da aplica√ß√£o
	docker-compose -f $(COMPOSE_FILE_PROD) logs -f app

logs-db: ## Ver logs do banco de dados
	docker-compose -f $(COMPOSE_FILE_PROD) logs -f db

# ==========================================
# Shell
# ==========================================
shell: ## Acessar shell do container da aplica√ß√£o
	docker exec -it $(APP_CONTAINER) sh

db-shell: ## Acessar shell do PostgreSQL
	docker exec -it $(DB_CONTAINER) psql -U gsproducoes -d gsproducoes_intranet

# ==========================================
# Banco de Dados
# ==========================================
migrate: ## Aplicar schema do banco (db:push)
	@echo "üì§ Aplicando schema do banco..."
	docker exec $(APP_CONTAINER) npm run db:push
	@echo "‚úÖ Schema aplicado!"

migrate-generate: ## Gerar migrations
	@echo "üìù Gerando migrations..."
	docker exec $(APP_CONTAINER) npm run db:generate
	@echo "‚úÖ Migrations geradas!"

migrate-run: ## Executar migrations
	@echo "‚ñ∂Ô∏è  Executando migrations..."
	docker exec $(APP_CONTAINER) npm run db:migrate
	@echo "‚úÖ Migrations executadas!"

seed: ## Popular banco com dados de exemplo
	@echo "üå± Populando banco com dados de exemplo..."
	docker exec -i $(DB_CONTAINER) psql -U gsproducoes -d gsproducoes_intranet < docs/database/complete-seed.sql
	@echo "‚úÖ Dados inseridos!"

db-reset: ## Resetar banco (APAGA TODOS OS DADOS!)
	@echo "‚ö†Ô∏è  ATEN√á√ÉO: Isso ir√° remover TODOS os dados!"
	@read -p "Tem certeza? Digite 'sim' para confirmar: " confirm; \
	if [ "$$confirm" = "sim" ]; then \
		echo "üõë Parando containers..."; \
		docker-compose -f $(COMPOSE_FILE_PROD) down -v; \
		echo "üöÄ Recriando ambiente..."; \
		docker-compose -f $(COMPOSE_FILE_PROD) up -d; \
		echo "‚è≥ Aguardando banco ficar pronto..."; \
		sleep 10; \
		echo "‚úÖ Banco resetado com sucesso!"; \
	else \
		echo "‚ùå Opera√ß√£o cancelada."; \
	fi

backup: ## Fazer backup do banco de dados
	@echo "üíæ Criando backup..."
	docker exec $(DB_CONTAINER) pg_dump -U gsproducoes gsproducoes_intranet > backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "‚úÖ Backup criado!"

# ==========================================
# Status e Informa√ß√µes
# ==========================================
ps: ## Ver status dos containers
	docker-compose -f $(COMPOSE_FILE_PROD) ps

stats: ## Ver estat√≠sticas de uso dos containers
	docker stats

health: ## Verificar health dos containers
	@echo "üè• Verificando sa√∫de dos containers..."
	@docker inspect $(APP_CONTAINER) | grep -A 5 '"Health"' || echo "Container n√£o encontrado"

# ==========================================
# Limpeza
# ==========================================
clean: ## Parar e remover containers (mant√©m volumes)
	@echo "üßπ Limpando containers..."
	docker-compose -f $(COMPOSE_FILE_PROD) down
	@echo "‚úÖ Containers removidos!"

clean-all: ## Parar e remover containers + volumes (APAGA DADOS!)
	@echo "‚ö†Ô∏è  ATEN√á√ÉO: Isso ir√° remover TODOS os dados!"
	@read -p "Tem certeza? Digite 'sim' para confirmar: " confirm; \
	if [ "$$confirm" = "sim" ]; then \
		docker-compose -f $(COMPOSE_FILE_PROD) down -v; \
		echo "‚úÖ Containers e volumes removidos!"; \
	else \
		echo "‚ùå Opera√ß√£o cancelada."; \
	fi

prune: ## Limpar recursos Docker n√£o utilizados
	@echo "üßπ Limpando recursos n√£o utilizados..."
	docker system prune -f
	@echo "‚úÖ Limpeza conclu√≠da!"

# ==========================================
# Rebuild
# ==========================================
rebuild: ## Rebuild completo (sem cache)
	@echo "üî® Rebuild completo..."
	docker-compose -f $(COMPOSE_FILE_PROD) build --no-cache
	@echo "‚úÖ Rebuild conclu√≠do!"

rebuild-up: ## Rebuild e iniciar
	@echo "üî® Rebuild e inicializa√ß√£o..."
	docker-compose -f $(COMPOSE_FILE_PROD) up --build -d
	@echo "‚úÖ Ambiente reconstru√≠do e iniciado!"

# ==========================================
# Testes
# ==========================================
test-connection: ## Testar conex√£o com o banco
	@echo "üîå Testando conex√£o com banco..."
	docker exec $(DB_CONTAINER) pg_isready -U gsproducoes
	@echo "‚úÖ Conex√£o OK!"

test-health: ## Testar endpoint de health
	@echo "üè• Testando health endpoint..."
	@curl -s http://localhost:3000/api/health | jq . || echo "Endpoint n√£o dispon√≠vel"
